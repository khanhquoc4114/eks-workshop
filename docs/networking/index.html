<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-networking/networking" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Networking | AWS EKS Workshop</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://khanhquoc4114.github.io/eks-workshop/img/aws-logo.png"><meta data-rh="true" name="twitter:image" content="https://khanhquoc4114.github.io/eks-workshop/img/aws-logo.png"><meta data-rh="true" property="og:url" content="https://khanhquoc4114.github.io/eks-workshop/docs/networking/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Networking | AWS EKS Workshop"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/eks-workshop/img/aws-logo.ico"><link data-rh="true" rel="canonical" href="https://khanhquoc4114.github.io/eks-workshop/docs/networking/"><link data-rh="true" rel="alternate" href="https://khanhquoc4114.github.io/eks-workshop/docs/networking/" hreflang="en"><link data-rh="true" rel="alternate" href="https://khanhquoc4114.github.io/eks-workshop/docs/networking/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Networking","item":"https://khanhquoc4114.github.io/eks-workshop/docs/networking/"}]}</script><link rel="alternate" type="application/rss+xml" href="/eks-workshop/blog/rss.xml" title="AWS EKS Workshop RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/eks-workshop/blog/atom.xml" title="AWS EKS Workshop Atom Feed"><link rel="stylesheet" href="/eks-workshop/assets/css/styles.e9f0cf4c.css">
<script src="/eks-workshop/assets/js/runtime~main.2a454b13.js" defer="defer"></script>
<script src="/eks-workshop/assets/js/main.1040d380.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/eks-workshop/img/aws-logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/eks-workshop/"><div class="navbar__logo"><img src="/eks-workshop/img/aws-logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/eks-workshop/img/aws-logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">AWS EKS Workshop</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/eks-workshop/docs/introduction/">Modules</a><a class="navbar__item navbar__link" href="/eks-workshop/contributor">Contributors</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/khanhquoc4114/eks-workshop" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/eks-workshop/docs/introduction/"><span title="Introduction and Setup" class="linkLabel_WmDU">Introduction and Setup</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/eks-workshop/docs/observability/"><span title="Observability" class="linkLabel_WmDU">Observability</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/eks-workshop/docs/networking/"><span title="Networking" class="linkLabel_WmDU">Networking</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/eks-workshop/docs/security/"><span title="Security" class="linkLabel_WmDU">Security</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/eks-workshop/docs/automation/"><span title="Automation" class="linkLabel_WmDU">Automation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/eks-workshop/docs/intro"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/eks-workshop/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Networking</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Networking</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h2>
<p>Understanding Kubernetes networking is critical for efficiently operating your cluster and applications. This guide covers Pod networking, service networking, Amazon VPC CNI configurations, VPC Lattice, and EKS Hybrid Nodes.</p>
<p>Amazon EKS uses Amazon VPC to provide networking capabilities to worker nodes and Kubernetes Pods. The cluster consists of an AWS-managed VPC hosting the Kubernetes control plane and a customer-managed VPC hosting worker nodes and AWS infrastructure.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-amazon-vpc-cni">1. Amazon VPC CNI<a href="#1-amazon-vpc-cni" class="hash-link" aria-label="Direct link to 1. Amazon VPC CNI" title="Direct link to 1. Amazon VPC CNI" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview-1">Overview<a href="#overview-1" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>Amazon EKS officially supports the Amazon VPC CNI plugin to implement Kubernetes Pod networking. The VPC CNI provides native integration with AWS VPC and works in underlay mode where Pods and hosts share the same network layer.</p>
<p>Worker nodes connect to the EKS control plane through the EKS public endpoint or EKS-managed elastic network interfaces (ENIs). The VPC CNI assigns Pod IP addresses from VPC subnets, making them consistent from both cluster and VPC perspectives.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-custom-networking">2. Custom Networking<a href="#2-custom-networking" class="hash-link" aria-label="Direct link to 2. Custom Networking" title="Direct link to 2. Custom Networking" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview-2">Overview<a href="#overview-2" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>By default, Amazon VPC CNI assigns Pods IP addresses from the primary subnet. Custom networking solves IP exhaustion issues by assigning Pod IPs from secondary VPC address spaces using ENIConfig custom resources.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="steps">Steps<a href="#steps" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps" translate="no">​</a></h3>
<p><strong>Step 1:</strong> Prepare environment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">prepare-environment networking/custom-networking</span><br></span></code></pre></div></div>
<p>This creates:</p>
<ul>
<li class="">Secondary CIDR range attached to VPC</li>
<li class="">Three additional subnets from secondary CIDR</li>
</ul>
<p><strong>Step 2:</strong> Review VPC architecture</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws ec2 describe-vpcs --vpc-ids $VPC_ID</span><br></span></code></pre></div></div>
<p>Expected output shows:</p>
<ul>
<li class="">Primary CIDR: <code>10.42.0.0/16</code></li>
<li class="">Secondary CIDR: <code>100.64.0.0/16</code></li>
</ul>
<p><strong>Step 3:</strong> List subnets</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws ec2 describe-subnets --filters &quot;Name=tag:created-by,Values=eks-workshop-v2&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --query &quot;Subnets[*].CidrBlock&quot;</span><br></span></code></pre></div></div>
<p>Subnets include:</p>
<ul>
<li class="">Public subnets (primary CIDR)</li>
<li class="">Private subnets (primary CIDR)</li>
<li class="">Secondary private subnets (secondary CIDR)</li>
</ul>
<p><strong>Step 4:</strong> Enable custom networking</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl set env daemonset aws-node -n kube-system AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG=true</span><br></span></code></pre></div></div>
<p><strong>Step 5:</strong> Create ENIConfig resources</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl kustomize ~/environment/eks-workshop/modules/networking/custom-networking/provision \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | envsubst | kubectl apply -f-</span><br></span></code></pre></div></div>
<p><strong>Step 6:</strong> Verify ENIConfig creation</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get ENIConfigs</span><br></span></code></pre></div></div>
<p><strong>Step 7:</strong> Configure automatic ENIConfig assignment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl set env daemonset aws-node -n kube-system ENI_CONFIG_LABEL_DEF=topology.kubernetes.io/zone</span><br></span></code></pre></div></div>
<p><strong>Step 8:</strong> Provision new node group</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws eks create-nodegroup --region $AWS_REGION \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --cluster-name $EKS_CLUSTER_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --nodegroup-name custom-networking \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --instance-types t3.medium --node-role $CUSTOM_NETWORKING_NODE_ROLE \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --subnets $PRIMARY_SUBNET_1 $PRIMARY_SUBNET_2 $PRIMARY_SUBNET_3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --labels type=customnetworking \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --scaling-config minSize=1,maxSize=1,desiredSize=1</span><br></span></code></pre></div></div>
<p><strong>Step 9:</strong> Wait for node group creation</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws eks wait nodegroup-active --cluster-name $EKS_CLUSTER_NAME --nodegroup-name custom-networking</span><br></span></code></pre></div></div>
<p><strong>Step 10:</strong> Verify new nodes</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes -L eks.amazonaws.com/nodegroup</span><br></span></code></pre></div></div>
<p>New nodes will use secondary CIDR for Pod IP allocation.</p>
<p><strong>Step 11:</strong> Deploy sample application
Deploy workloads to the new node group and verify they receive IPs from the secondary CIDR range.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-prefix-delegation">3. Prefix Delegation<a href="#3-prefix-delegation" class="hash-link" aria-label="Direct link to 3. Prefix Delegation" title="Direct link to 3. Prefix Delegation" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview-3">Overview<a href="#overview-3" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>Amazon VPC CNI assigns network prefixes to EC2 network interfaces to increase the number of available IP addresses and boost pod density per node. With prefix delegation, VPC CNI assigns /28 (16 IP addresses) IPv4 prefixes instead of individual secondary IP addresses.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="steps-1">Steps<a href="#steps-1" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps" translate="no">​</a></h3>
<p><strong>Step 1:</strong> Prepare environment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">prepare-environment networking/prefix</span><br></span></code></pre></div></div>
<p><strong>Step 2:</strong> Verify VPC CNI installation</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get pods --selector=k8s-app=aws-node -n kube-system</span><br></span></code></pre></div></div>
<p><strong>Step 3:</strong> Check CNI version</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl describe daemonset aws-node --namespace kube-system | grep Image | cut -d &quot;/&quot; -f 2</span><br></span></code></pre></div></div>
<p>Version must be 1.9.0 or later.</p>
<p><strong>Step 4:</strong> Confirm prefix delegation is enabled</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get ds aws-node -o yaml -n kube-system | yq &#x27;.spec.template.spec.containers[].env&#x27;</span><br></span></code></pre></div></div>
<p>Look for <code>ENABLE_PREFIX_DELEGATION: &quot;true&quot;</code></p>
<p><strong>Step 5:</strong> Verify prefixes assigned to nodes</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws ec2 describe-instances --filters &quot;Name=tag-key,Values=eks:cluster-name&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Name=tag-value,Values=${EKS_CLUSTER_NAME}&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --query &#x27;Reservations[*].Instances[].{InstanceId: InstanceId, Prefixes: NetworkInterfaces[].Ipv4Prefixes[]}&#x27;</span><br></span></code></pre></div></div>
<p><strong>Step 6:</strong> Review prefix allocation
Each node should have one or more /28 IPv4 prefixes assigned.</p>
<p><strong>Step 7:</strong> Monitor pod density
With prefix delegation, nodes can support significantly more pods than with secondary IP mode.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-network-policies">4. Network Policies<a href="#4-network-policies" class="hash-link" aria-label="Direct link to 4. Network Policies" title="Direct link to 4. Network Policies" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview-4">Overview<a href="#overview-4" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>Kubernetes Network Policies enable defining and enforcing rules on traffic flow between pods, namespaces, and IP blocks. They act as a virtual firewall for segmenting and securing the cluster.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="steps-2">Steps<a href="#steps-2" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps" translate="no">​</a></h3>
<p><strong>Step 1:</strong> Prepare environment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">prepare-environment networking/network-policies</span><br></span></code></pre></div></div>
<p><strong>Step 2:</strong> Review sample application architecture</p>
<p>Each component runs in its own namespace: ui, catalog, orders, etc.</p>
<p><strong>Step 3:</strong> Verify current connectivity (no restrictions)</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec deployment/catalog -n catalog -- curl -s http://checkout.checkout/health</span><br></span></code></pre></div></div>
<p>Should return success response.</p>
<p><strong>Step 4:</strong> Implement default deny egress policy</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -n ui -f ~/environment/eks-workshop/modules/networking/network-policies/apply-network-policies/default-deny.yaml</span><br></span></code></pre></div></div>
<p><strong>Step 5:</strong> Verify egress blocked</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec deployment/ui -n ui -- curl -s http://catalog.catalog/health --connect-timeout 5</span><br></span></code></pre></div></div>
<p>Should timeout.</p>
<p><strong>Step 6:</strong> Apply selective egress policy for UI</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f ~/environment/eks-workshop/modules/networking/network-policies/apply-network-policies/allow-ui-egress.yaml</span><br></span></code></pre></div></div>
<p>This allows:</p>
<ul>
<li class="">Traffic to all service components</li>
<li class="">Traffic to kube-system namespace for DNS</li>
</ul>
<p><strong>Step 7:</strong> Verify UI can access catalog service</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec deployment/ui -n ui -- curl http://catalog.catalog/health</span><br></span></code></pre></div></div>
<p>Should succeed.</p>
<p><strong>Step 8:</strong> Verify UI cannot access database</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec deployment/ui -n ui -- curl -v telnet://catalog-mysql.catalog:3306 --connect-timeout 5</span><br></span></code></pre></div></div>
<p>Should timeout.</p>
<p><strong>Step 9:</strong> Apply ingress policy for catalog service</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f ~/environment/eks-workshop/modules/networking/network-policies/apply-network-policies/allow-catalog-ingress-webservice.yaml</span><br></span></code></pre></div></div>
<p>Allows traffic only from UI namespace.</p>
<p><strong>Step 10:</strong> Verify UI can access catalog</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec deployment/ui -n ui -- curl -v catalog.catalog/health --connect-timeout 5</span><br></span></code></pre></div></div>
<p><strong>Step 11:</strong> Verify orders cannot access catalog</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec deployment/orders -n orders -- curl -v catalog.catalog/health --connect-timeout 5</span><br></span></code></pre></div></div>
<p>Should timeout.</p>
<p><strong>Step 12:</strong> Apply ingress policy for catalog database</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f ~/environment/eks-workshop/modules/networking/network-policies/apply-network-policies/allow-catalog-ingress-db.yaml</span><br></span></code></pre></div></div>
<p>Allows database access only from catalog service pods.</p>
<p><strong>Step 13:</strong> Test database isolation</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl exec deployment/orders -n orders -- curl -v telnet://catalog-mysql.catalog:3306 --connect-timeout 5</span><br></span></code></pre></div></div>
<p>Should timeout, confirming database is protected.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-security-groups-for-pods">5. Security Groups for Pods<a href="#5-security-groups-for-pods" class="hash-link" aria-label="Direct link to 5. Security Groups for Pods" title="Direct link to 5. Security Groups for Pods" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview-5">Overview<a href="#overview-5" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>Security Groups for Pods allow using Amazon EC2 security groups to define rules governing inbound and outbound network traffic to and from specific pods. This provides pod-level network security instead of node-level.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="steps-3">Steps<a href="#steps-3" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps" translate="no">​</a></h3>
<p><strong>Step 1:</strong> Prepare environment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">prepare-environment networking/securitygroups-for-pods</span><br></span></code></pre></div></div>
<p>This creates:</p>
<ul>
<li class="">Amazon RDS instance</li>
<li class="">EC2 security group for RDS access</li>
</ul>
<p><strong>Step 2:</strong> Review current catalog setup</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n catalog get pod</span><br></span></code></pre></div></div>
<p>Shows catalog service and MySQL database pods.</p>
<p><strong>Step 3:</strong> Check catalog database endpoint</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n catalog exec deployment/catalog -- env \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | grep RETAIL_CATALOG_PERSISTENCE_ENDPOINT</span><br></span></code></pre></div></div>
<p>Currently points to in-cluster MySQL.</p>
<p><strong>Step 4:</strong> Verify RDS security group</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export CATALOG_SG_ID=$(aws ec2 describe-security-groups \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --filters Name=vpc-id,Values=$VPC_ID Name=group-name,Values=$EKS_CLUSTER_NAME-catalog \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --query &quot;SecurityGroups[0].GroupId&quot; --output text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ec2 describe-security-groups --group-ids $CATALOG_SG_ID</span><br></span></code></pre></div></div>
<p>Security group allows:</p>
<ul>
<li class="">Inbound HTTP API traffic on port 8080</li>
<li class="">All egress traffic</li>
<li class="">Access to RDS database</li>
</ul>
<p><strong>Step 5:</strong> Create SecurityGroupPolicy</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl kustomize ~/environment/eks-workshop/modules/networking/securitygroups-for-pods/sg \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | envsubst | kubectl apply -f-</span><br></span></code></pre></div></div>
<p>This maps the security group to catalog service pods.</p>
<p><strong>Step 6:</strong> Recycle catalog pods</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl delete pod -n catalog -l app.kubernetes.io/component=service</span><br></span></code></pre></div></div>
<p><strong>Step 7:</strong> Wait for rollout</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl rollout status -n catalog deployment/catalog --timeout 30s</span><br></span></code></pre></div></div>
<p><strong>Step 8:</strong> Verify RDS connection</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl -n catalog logs deployment/catalog</span><br></span></code></pre></div></div>
<p>Should show connection to RDS endpoint.</p>
<p><strong>Step 9:</strong> Inspect pod ENI
Catalog pods now have dedicated branch ENIs with the security group attached.</p>
<p><strong>Step 10:</strong> Verify trunk interface on node
Check node for <code>aws-k8s-trunk-eni</code> interface created by VPC Resource Controller.</p>
<p><strong>Step 11:</strong> Test connectivity
Catalog pods can now access RDS while other pods cannot due to security group restrictions.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-amazon-vpc-lattice">6. Amazon VPC Lattice<a href="#6-amazon-vpc-lattice" class="hash-link" aria-label="Direct link to 6. Amazon VPC Lattice" title="Direct link to 6. Amazon VPC Lattice" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview-6">Overview<a href="#overview-6" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>Amazon VPC Lattice is an application layer networking service providing consistent connectivity, security, and monitoring for service-to-service communication across VPCs and accounts.</p>
<p>Benefits:</p>
<ul>
<li class="">Increased developer productivity</li>
<li class="">Improved security posture</li>
<li class="">Better application scalability and resilience</li>
<li class="">Deployment flexibility with heterogeneous infrastructure</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="steps-4">Steps<a href="#steps-4" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps" translate="no">​</a></h3>
<p><strong>Step 1:</strong> Prepare environment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">prepare-environment networking/vpc-lattice</span><br></span></code></pre></div></div>
<p>This installs:</p>
<ul>
<li class="">IAM role for Gateway API controller</li>
<li class="">AWS Load Balancer Controller</li>
</ul>
<p><strong>Step 2:</strong> Configure security group for VPC Lattice</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CLUSTER_SG=$(aws eks describe-cluster --name $EKS_CLUSTER_NAME --output json| jq -r &#x27;.cluster.resourcesVpcConfig.clusterSecurityGroupId&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PREFIX_LIST_ID=$(aws ec2 describe-managed-prefix-lists --query &quot;PrefixLists[?PrefixListName==&quot;\&#x27;com.amazonaws.$AWS_REGION.vpc-lattice\&#x27;&quot;].PrefixListId&quot; | jq -r &#x27;.[]&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ec2 authorize-security-group-ingress --group-id $CLUSTER_SG --ip-permissions &quot;PrefixListIds=[{PrefixListId=${PREFIX_LIST_ID}}],IpProtocol=-1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PREFIX_LIST_ID_IPV6=$(aws ec2 describe-managed-prefix-lists --query &quot;PrefixLists[?PrefixListName==&quot;\&#x27;com.amazonaws.$AWS_REGION.ipv6.vpc-lattice\&#x27;&quot;].PrefixListId&quot; | jq -r &#x27;.[]&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ec2 authorize-security-group-ingress --group-id $CLUSTER_SG --ip-permissions &quot;PrefixListIds=[{PrefixListId=${PREFIX_LIST_ID_IPV6}}],IpProtocol=-1&quot;</span><br></span></code></pre></div></div>
<p><strong>Step 3:</strong> Install Gateway API CRDs</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.0/standard-install.yaml</span><br></span></code></pre></div></div>
<p><strong>Step 4:</strong> Install VPC Lattice controller</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws ecr-public get-login-password --region us-east-1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | helm registry login --username AWS --password-stdin public.ecr.aws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm install gateway-api-controller \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oci://public.ecr.aws/aws-application-networking-k8s/aws-gateway-controller-chart \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --version=v${LATTICE_CONTROLLER_VERSION} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --create-namespace \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --set=aws.region=${AWS_REGION} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --set serviceAccount.annotations.&quot;eks\.amazonaws\.com/role-arn&quot;=&quot;$LATTICE_IAM_ROLE&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --set=defaultServiceNetwork=${EKS_CLUSTER_NAME} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --namespace gateway-api-controller \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --wait</span><br></span></code></pre></div></div>
<p><strong>Step 5:</strong> Verify controller deployment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get deployment -n gateway-api-controller</span><br></span></code></pre></div></div>
<p><strong>Step 6:</strong> Create GatewayClass</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl apply -f ~/environment/eks-workshop/modules/networking/vpc-lattice/controller/gatewayclass.yaml</span><br></span></code></pre></div></div>
<p><strong>Step 7:</strong> Create Gateway (Service Network)</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat ~/environment/eks-workshop/modules/networking/vpc-lattice/controller/eks-workshop-gw.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | envsubst | kubectl apply -f -</span><br></span></code></pre></div></div>
<p><strong>Step 8:</strong> Verify Gateway creation</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get gateway -n checkout</span><br></span></code></pre></div></div>
<p><strong>Step 9:</strong> Wait for Gateway to be programmed</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl wait --for=condition=Programmed gateway/${EKS_CLUSTER_NAME} -n checkout</span><br></span></code></pre></div></div>
<p><strong>Step 10:</strong> View Service Network in AWS Console
Navigate to VPC Console → Lattice → Service Networks</p>
<p><strong>Step 11:</strong> Configure routes
Create HTTPRoute resources to define traffic routing rules.</p>
<p><strong>Step 12:</strong> Test routing
Verify traffic flows through VPC Lattice according to defined routes.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-eks-hybrid-nodes">7. EKS Hybrid Nodes<a href="#7-eks-hybrid-nodes" class="hash-link" aria-label="Direct link to 7. EKS Hybrid Nodes" title="Direct link to 7. EKS Hybrid Nodes" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview-7">Overview<a href="#overview-7" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h3>
<p>Amazon EKS Hybrid Nodes unifies Kubernetes management across cloud, on-premises, and edge environments, providing flexibility to run workloads anywhere while maintaining centralized control.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="steps-5">Steps<a href="#steps-5" class="hash-link" aria-label="Direct link to Steps" title="Direct link to Steps" translate="no">​</a></h3>
<p><strong>Step 1:</strong> Prepare environment</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">prepare-environment networking/eks-hybrid-nodes</span><br></span></code></pre></div></div>
<p>This creates:</p>
<ul>
<li class="">Transit Gateway connection to simulated remote network</li>
<li class="">EC2 instance simulating on-premises node</li>
</ul>
<p><strong>Step 2:</strong> Create SSM hybrid activation</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export ACTIVATION_JSON=$(aws ssm create-activation \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--default-instance-name hybrid-ssm-node \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--iam-role $HYBRID_ROLE_NAME \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--registration-limit 1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--region $AWS_REGION)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ACTIVATION_ID=$(echo $ACTIVATION_JSON | jq -r &quot;.ActivationId&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ACTIVATION_CODE=$(echo $ACTIVATION_JSON | jq -r &quot;.ActivationCode&quot;)</span><br></span></code></pre></div></div>
<p><strong>Step 3:</strong> Create NodeConfig</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cat ~/environment/eks-workshop/modules/networking/eks-hybrid-nodes/nodeconfig.yaml \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| envsubst &gt; nodeconfig.yaml</span><br></span></code></pre></div></div>
<p><strong>Step 4:</strong> Copy NodeConfig to hybrid node</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p ~/.ssh/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ssh-keyscan -H $HYBRID_NODE_IP &amp;&gt; ~/.ssh/known_hosts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp -i private-key.pem nodeconfig.yaml ubuntu@$HYBRID_NODE_IP:/home/ubuntu/nodeconfig.yaml</span><br></span></code></pre></div></div>
<p><strong>Step 5:</strong> Install nodeadm dependencies</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh -i private-key.pem ubuntu@$HYBRID_NODE_IP \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;sudo nodeadm install $EKS_CLUSTER_VERSION --credential-provider ssm&quot;</span><br></span></code></pre></div></div>
<p>Installs: containerd, kubelet, kubectl, AWS SSM components</p>
<p><strong>Step 6:</strong> Initialize hybrid node</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ssh -i private-key.pem ubuntu@$HYBRID_NODE_IP \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;sudo nodeadm init -c file://nodeconfig.yaml&quot;</span><br></span></code></pre></div></div>
<p><strong>Step 7:</strong> Verify node joined cluster</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes</span><br></span></code></pre></div></div>
<p>Node appears with <code>mi-</code> prefix (SSM credential provider) but in <code>NotReady</code> state.</p>
<p><strong>Step 8:</strong> Add Cilium Helm repo</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo add cilium https://helm.cilium.io/</span><br></span></code></pre></div></div>
<p><strong>Step 9:</strong> Install Cilium CNI</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm install cilium cilium/cilium \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--version 1.17.1 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--namespace cilium \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--create-namespace \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--values ~/environment/eks-workshop/modules/networking/eks-hybrid-nodes/cilium-values.yaml</span><br></span></code></pre></div></div>
<p>Configuration includes:</p>
<ul>
<li class="">Node affinity for hybrid nodes only</li>
<li class="">Cluster-pool IPAM mode</li>
<li class="">Dedicated CIDR (10.53.0.0/16) for hybrid node pods</li>
<li class="">/25 subnets per node (128 IPs)</li>
</ul>
<p><strong>Step 10:</strong> Wait for node to become Ready</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl wait --for=condition=Ready nodes --all --timeout=2m</span><br></span></code></pre></div></div>
<p><strong>Step 11:</strong> Verify hybrid node status</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get nodes</span><br></span></code></pre></div></div>
<p>Hybrid node should now show <code>Ready</code> status.</p>
<p><strong>Step 12:</strong> Route traffic to hybrid node
Deploy workloads with node selectors targeting hybrid nodes.</p>
<p><strong>Step 13:</strong> Test cloud bursting
Scale applications to utilize both cloud and hybrid nodes.</p>
<hr></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/khanhquoc4114/eks-workshop/tree/main/packages/create-docusaurus/templates/shared/docs/networking/networking.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/eks-workshop/docs/observability/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Observability</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/eks-workshop/docs/security/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Security</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#1-amazon-vpc-cni" class="table-of-contents__link toc-highlight">1. Amazon VPC CNI</a><ul><li><a href="#overview-1" class="table-of-contents__link toc-highlight">Overview</a></li></ul></li><li><a href="#2-custom-networking" class="table-of-contents__link toc-highlight">2. Custom Networking</a><ul><li><a href="#overview-2" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#steps" class="table-of-contents__link toc-highlight">Steps</a></li></ul></li><li><a href="#3-prefix-delegation" class="table-of-contents__link toc-highlight">3. Prefix Delegation</a><ul><li><a href="#overview-3" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#steps-1" class="table-of-contents__link toc-highlight">Steps</a></li></ul></li><li><a href="#4-network-policies" class="table-of-contents__link toc-highlight">4. Network Policies</a><ul><li><a href="#overview-4" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#steps-2" class="table-of-contents__link toc-highlight">Steps</a></li></ul></li><li><a href="#5-security-groups-for-pods" class="table-of-contents__link toc-highlight">5. Security Groups for Pods</a><ul><li><a href="#overview-5" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#steps-3" class="table-of-contents__link toc-highlight">Steps</a></li></ul></li><li><a href="#6-amazon-vpc-lattice" class="table-of-contents__link toc-highlight">6. Amazon VPC Lattice</a><ul><li><a href="#overview-6" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#steps-4" class="table-of-contents__link toc-highlight">Steps</a></li></ul></li><li><a href="#7-eks-hybrid-nodes" class="table-of-contents__link toc-highlight">7. EKS Hybrid Nodes</a><ul><li><a href="#overview-7" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#steps-5" class="table-of-contents__link toc-highlight">Steps</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS. <br> Copyright © 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>